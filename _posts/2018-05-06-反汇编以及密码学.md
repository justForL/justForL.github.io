---
title: OCçš„åæ±‡ç¼–ä»¥åŠå¯†ç å­¦

layout: post

tags: æ±‡ç¼–

---
## Blockçš„åæ±‡ç¼–

ç¼–å†™ä¸€ä¸ªblockå¹¶è°ƒç”¨,æŸ¥çœ‹æ±‡ç¼–ä»£ç 

```objectivec
- (void)viewDidLoad {
    [super viewDidLoad];

    void (^testBlock)(void)=^(){
        NSLog(@"123");
    };
    
    testBlock();
}

```
![1-1](https://ws1.sinaimg.cn/large/006tKfTcly1fr1ep7w7vgj31ce0xuwps.jpg)
<center>1-1</center>

```c
åæ±‡ç¼–ä»¥åŠå¯†ç å­¦`-[ViewController viewDidLoad]:

    // æ‹‰ä¼¸æ ˆç©ºé—´
    0x10125674c <+0>:   sub    sp, sp, #0x40             ; =0x40 
    0x101256750 <+4>:   stp    x29, x30, [sp, #0x30]
    0x101256754 <+8>:   add    x29, sp, #0x30            ; =0x30 


    // x8ä¿å­˜æŒ‡é’ˆsp+#0x10
    0x101256758 <+12>:  add    x8, sp, #0x10             ; =0x10 

    // é‡åˆ°adrpå’Œaddç»„åˆä¸€èˆ¬å°±è¦æƒ³åˆ°æ˜¯å…¨å±€å˜é‡æˆ–è€…å¸¸é‡   è®¡ç®—ç‰©ç†åœ°å€ä¸º  101252cb0
    0x10125675c <+16>:  adrp   x9, 2
    0x101256760 <+20>:  add    x9, x9, #0xcb0            ; =0xcb0 


    // x10 çš„ç‰©ç†åœ°å€ä¸º   101252cc8
    0x101256764 <+24>:  adrp   x10, 2
    0x101256768 <+28>:  add    x10, x10, #0xcc8          ; =0xcc8 


    //ä¿å­˜x0 x1å¯„å­˜å™¨ä¸­çš„å€¼  ç°åœºä¿æŠ¤
    0x10125676c <+32>:  stur   x0, [x29, #-0x8]
    0x101256770 <+36>:  stur   x1, [x29, #-0x10]

    // è¯»å‡ºx0çš„å€¼
    0x101256774 <+40>:  ldur   x0, [x29, #-0x8]


    // å†æ¬¡å°†x0å¯„å­˜å™¨ä¸­çš„å€¼å­˜å…¥0x10
    0x101256778 <+44>:  str    x0, [sp, #0x10]

    // -------------ç”±äºæˆ‘ä»¬æ˜¯åœ¨viewControllerçš„ViewDidLoadä¸­ç¼–å†™çš„block æ‰€ä»¥ä¼šè°ƒç”¨ä¸€æ¬¡[super viewDidLoad]
    0x10125677c <+48>:  ldr    x10, [x10]
    0x101256780 <+52>:  str    x10, [sp, #0x18]
    0x101256784 <+56>:  ldr    x1, [x9]
    0x101256788 <+60>:  mov    x0, x8
    0x10125678c <+64>:  bl     0x101256b88               ; symbol stub for: objc_msgSendSuper2

    // -----------------


    // x8çš„çœŸå®ç‰©ç†åœ°å€ä¸º   0x101258080  å›¾1-2ä¸­å¯è§æ‰“å°å‡ºæ¥blockç±»å‹å­—ç¬¦ä¸²
    0x101256790 <+68>:  adrp   x8, 2
    0x101256794 <+72>:  add    x8, x8, #0x80             ; =0x80 

    //å°†x8èµ‹å€¼ç»™x0
->  0x101256798 <+76>:  mov    x0, x8


    // å£°æ˜çš„çš„block
    0x10125679c <+80>:  bl     0x101256bac               ; symbol stub for: objc_retainBlock

    // ä¿æŠ¤x0
    0x1012567a0 <+84>:  str    x0, [sp, #0x8]
    0x1012567a4 <+88>:  ldr    x8, [sp, #0x8]
    0x1012567a8 <+92>:  mov    x0, x8

    // ä»å†…å­˜ä¸­å°† 31è¡Œçš„x0èµ‹å€¼ç»™x8
    0x1012567ac <+96>:  ldr    x8, [x8, #0x10]
    0x1012567b0 <+100>: blr    x8
    0x1012567b4 <+104>: mov    x8, #0x0
    0x1012567b8 <+108>: add    x9, sp, #0x8              ; =0x8 
    0x1012567bc <+112>: mov    x0, x9
    0x1012567c0 <+116>: mov    x1, x8

    //è°ƒç”¨block
    0x1012567c4 <+120>: bl     0x101256bb8               ; symbol stub for: objc_storeStrong

    // æ¢å¤ç°åœº
    0x1012567c8 <+124>: ldp    x29, x30, [sp, #0x30]

    //æ”¶ç¼©æ ˆç©ºé—´
    0x1012567cc <+128>: add    sp, sp, #0x40             ; =0x40 
    0x1012567d0 <+132>: ret 

```
![1-2](https://ws2.sinaimg.cn/large/006tKfTcly1fr1hohstzvj30ua0aqgns.jpg)
<center>1-2</center>

> å½“æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹è¿™ä¸ªblockç”Ÿå‘½ä¸€ä¸ªint a åœ¨blockä¸­ä½¿ç”¨ä¸€ä¸‹å˜é‡a,æ­¤æ—¶å†æ¬¡ç¼–è¯‘çš„æ—¶å€™,æ±‡ç¼–å‘ç”Ÿäº†å˜åŒ–

```
- (void)viewDidLoad {
    [super viewDidLoad];
    int a = 10;
    void (^testBlock)(void)=^(){
        NSLog(@"%d",a);
    };
    
    testBlock();
}

```

æ­¤æ—¶åœ¨xCodeä¸­çœ‹æ±‡ç¼–æ‰¾è¿™ä¸ªblockçš„ç±»å‹çš„æ—¶å€™,ä¼šå¾ˆéº»çƒ¦,éœ€è¦ä¸€æ¬¡æ¬¡çš„è®¡ç®—å†…å­˜å¹¶æŸ¥çœ‹å†…å­˜ä¸­çš„å­˜æ”¾çš„å€¼,æ­¤æ—¶æˆ‘ä»¬åœ¨iadProä¸­æ‰“å¼€MachOæ–‡ä»¶,ä¼šå¾ˆæ–¹ä¾¿çš„å¸®åŠ©æˆ‘ä»¬åˆ†æä»£ç 


![](https://ws3.sinaimg.cn/large/006tKfTcly1fr1j0exqthj31e00tok3g.jpg)
<center>1-3</center>


## OCä»£ç åæ±‡ç¼–
### åæ±‡ç¼–ocä»£ç 

```c
åæ±‡ç¼–ä»¥åŠå¯†ç å­¦`main:
    // æ‹‰ä¼¸æ ˆç©ºé—´  ä¿å­˜ç°åœº
    0x100e726a0 <+0>:   sub    sp, sp, #0x30             ; =0x30 
    0x100e726a4 <+4>:   stp    x29, x30, [sp, #0x20]
    0x100e726a8 <+8>:   add    x29, sp, #0x20            ; =0x20 

    //  è®¡ç®—ä¸€ä¸‹çœŸå®åœ°å€     0x100e74e30    x8
    0x100e726ac <+12>:  adrp   x8, 2
    0x100e726b0 <+16>:  add    x8, x8, #0xe30            ; =0xe30 

    //   0x100e74e40      0x0100e74ed8   x9
    0x100e726b4 <+20>:  adrp   x9, 2
    0x100e726b8 <+24>:  add    x9, x9, #0xe40            ; =0xe40

     
    0x100e726bc <+28>:  stur   wzr, [x29, #-0x4]
    0x100e726c0 <+32>:  stur   w0, [x29, #-0x8]
    0x100e726c4 <+36>:  str    x1, [sp, #0x10]
    0x100e726c8 <+40>:  ldr    x9, [x9]

    //  ç”±blæ‰§è¡Œå‡½æ•°,objc_msgSend å¯çŸ¥  x0,x1ä¸ºå‚æ•°(å¯¹è±¡,sel)   x0=x9(11è¡Œ)  x1=[x8](7è¡Œ) å›¾1-4
    0x100e726cc <+44>:  ldr    x1, [x8]
    0x100e726d0 <+48>:  mov    x0, x9
    0x100e726d4 <+52>:  bl     0x100e72b14               ; symbol stub for: objc_msgSend

    //  çœŸå®åœ°å€ä¸º0x100e74e38 æ ¹æ®objc_msgSend çš„æ–¹æ³•ç‰¹æ€§å¯ä»¥çœ‹å‡º  x8æ˜¯sel æ‰“å°ä¹‹å¦‚å›¾1-5
    0x100e726d8 <+56>:  adrp   x8, 2
    0x100e726dc <+60>:  add    x8, x8, #0xe38            ; =0xe38 

    
    0x100e726e0 <+64>:  ldr    x1, [x8]
    0x100e726e4 <+68>:  bl     0x100e72b14               ; symbol stub for: objc_msgSend
    0x100e726e8 <+72>:  mov    x8, #0x0
    0x100e726ec <+76>:  add    x9, sp, #0x8              ; =0x8 
    0x100e726f0 <+80>:  str    x0, [sp, #0x8]
->  0x100e726f4 <+84>:  stur   wzr, [x29, #-0x4]
    0x100e726f8 <+88>:  mov    x0, x9
    0x100e726fc <+92>:  mov    x1, x8
    0x100e72700 <+96>:  bl     0x100e72b44               ; symbol stub for: objc_storeStrong
    0x100e72704 <+100>: ldur   w0, [x29, #-0x4]
    0x100e72708 <+104>: ldp    x29, x30, [sp, #0x20]
    0x100e7270c <+108>: add    sp, sp, #0x30             ; =0x30 
    0x100e72710 <+112>: ret  

```
![](https://ws2.sinaimg.cn/large/006tKfTcly1fr1lwyq7efj31by14m15f.jpg)
<center>1-4</center>

![](https://ws2.sinaimg.cn/large/006tKfTcly1fr1myb8rv5j30xu05ijsg.jpg)
<center>1-5</center>

> ç”±æ­¤å€ŸåŠ©runtimeçš„æ¶ˆæ¯å‘é€æœºåˆ¶å¯ä»¥è¿˜åŸocä»£ç ğŸ˜†,è™½ç„¶å¯ä»¥é€šè¿‡iadProè¿™æ ·çš„ç¥å™¨,å®ƒå·²ç»å¸®æˆ‘ä»¬åšå¥½äº†,å¯æ˜¯,æˆ‘ä»¬è¿˜æ˜¯å¾—çŸ¥é“ä¸åˆ©ç”¨å·¥å…·æ€ä¹ˆæ¥è¿˜åŸä»£ç ä¸æ˜¯å’©

### objc_storeStrong

> OCä¸­æ‰€æœ‰ç”¨strongä¿®é¥°çš„å˜é‡éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•

```c
void objc_storeStrong(*location, id obj) {
	id pre = *location;
	if(pre == obj) {
		return;
	}
	objc_retain(obj);
	*location=obj;
	objc_release(pre);
}
```

> é‡Šæ”¾å¯¹è±¡çš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨objc_storeStrong,é‡Šæ”¾å‰æ‰“å°x0 x1å¯„å­˜å™¨å³å¯çœ‹åˆ°,x0å­˜æ”¾çš„æ˜¯å¯¹è±¡æŒ‡é’ˆ,è€Œæ­¤æ—¶çš„x1å­˜æ”¾çš„æ˜¯0x0 è°ƒç”¨ä¸Šè¿°å‡½æ•°å,å³å¯å°†å¯¹è±¡æŒ‡é’ˆç½®ä¸ºnil,å³é‡Šæ”¾æˆåŠŸ.


åœ¨idaProä¸­å¯ä»¥å¾ˆçœ‹åˆ°åœ°å€ä»¥åŠæ–¹æ³•å,è¿™ä¸ªå¯ä»¥åˆ©ç”¨MachOViewæŸ¥çœ‹MachOæ–‡ä»¶çš„ç»“æ„,åœ¨textæ®µä¸­çš„methodNameä¸­å¯ä»¥æŸ¥çœ‹åˆ°åœ°å€ä¸æ–¹æ³•åçš„å¯¹åº”å…³ç³»,iadProå¯¹å…¶åšäº†å¯¹åº”å…³ç³»,æ–¹ä¾¿æˆ‘ä»¬é€†å‘å¼€å‘,å¢åŠ æ•ˆç‡ğŸ˜†
## ASLR
[ç™¾åº¦ç™¾ç§‘ASLR](https://baike.baidu.com/item/aslr/5779647?fr=aladdin)

æˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„OCæ–¹æ³•å¦‚ä¸‹:
![](https://ws3.sinaimg.cn/large/006tKfTcly1fr1tumt1c0j30y007g0tw.jpg)
ç”¨iadProæ‰“å¼€æŸ¥çœ‹å¯¹åº”çš„touchesBegan:withEvent:çš„æ–¹æ³•åœ°å€:
![](https://ws2.sinaimg.cn/large/006tKfTcly1fr1u1q6iwhj31kw0oz7ss.jpg)

æŒ‰ç…§å¸¸è§„æ–¹æ³•,æˆ‘ä»¬å»åˆ°xcodeä¸­ç»™ä»–æ‰“ä¸Šæ–­ç‚¹æµ‹è¯•ä¸€ä¸‹,ä¼šå‘ç°åœ°å€ä¸å­˜åœ¨,è¿™ä¹Ÿå°±è¯´æ˜äº†aslrçš„å­˜åœ¨o(â•¥ï¹â•¥)o

![](https://ws4.sinaimg.cn/large/006tKfTcly1fr1u410elhj318q07k0ud.jpg)

è™½ç„¶æ–­ç‚¹æ‰“ä¸Šäº†,å¯æ˜¯å´ä¸ä»¥å¾€æ‰“ä¸Šæ–­ç‚¹ä¸åŒ,æ²¡æœ‰ä½ç½®ä¿¡æ¯ä»¥åŠæ–¹æ³•æè¿°.

å½“æˆ‘ä»¬åœ¨xCodeä¸­åˆ©ç”¨breakpoint set å¯¹touchesBegan:withEvent:æ‰“æ–­ç‚¹æ—¶å¦‚ä¸‹å›¾:
![](https://ws4.sinaimg.cn/large/006tKfTcly1fr1ub3nq04j31c715ttvx.jpg)

æ–­ç‚¹å¤„çš„åœ°å€æ˜¯è¿›å…¥äº†touchesæ–¹æ³•åçš„åœ°å€,åœ¨æ±‡ç¼–ä»£ç çš„èµ·å§‹å¤„æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…å­˜åœ°å€ä¸º0x1010963dc,æˆ‘ä»¬è¿›è¡Œå¯¹æ¯”ä¸€ä¸‹iadProç»™å‡ºçš„åœ°å€å’Œxcodeçš„çœŸå®åœ°å€

```
xcode: 0x1010963dc

iadPro:0x1000063DC

```

è¿™æ ·å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡ºç›¸å·®äº†109,è¿™å°±æ˜¯aslrçš„åç§»é‡,è¿™ä¸ªåç§»é‡æ˜¯lldbåœ¨è¿è¡Œæ—¶æ‰åˆ†é…çš„åç§»é‡,è¿™æ˜¯æˆ‘ä»¬æœ‰æºç çš„æƒ…å†µä¸‹,æ¯”è¾ƒå‘ç°çš„,å¯æ˜¯åœ¨æˆ‘ä»¬é€†å‘åˆ«äººçš„appçš„æ—¶å€™æˆ‘ä»¬æ€ä¹ˆæŸ¥çœ‹è¿™ä¸ªåç§»é‡å‘¢?è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é•œåƒåˆ—è¡¨,æ¥æŸ¥çœ‹

![](https://ws1.sinaimg.cn/large/006tKfTcly1fr1uhpsayuj31hq14ck5b.jpg)

åœ¨é¦–æ¬¡åŠ è½½å¯åŠ¨appçš„æ—¶å€™,lldbä¼šæŠŠæ•´ä¸ªappåŠ è½½åˆ°å†…å­˜,ç„¶åå°†æ‰€éœ€è¦çš„åŠ¨æ€åº“è£…è½½åˆ°å†…å­˜ä¸­,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæŸ¥çœ‹å‡º109çš„åç§»é‡,æ£’æ£’å“’ğŸ˜†

* image list è·å–åŸºåœ°å€

è¿™æ ·,åœ¨ä¸çŸ¥é“æºç çš„æƒ…å†µä¸‹,æˆ‘ä»¬ä¹Ÿèƒ½ç»™æŒ‡å®šæ–¹æ³•ä¸‹æ–­ç‚¹å•¦

```
image:  0x101090000
iadPro: 0x1000063DC

åˆå¹¶åç§»é‡:0x1010963DC
```

æˆ‘ä»¬åˆ©ç”¨å†…å­˜åœ°å€ä¸‹æ–­ç‚¹çš„æ–¹æ³•æ¥è¯•éªŒä¸€ä¸‹,é¦–å…ˆæ¸…ç©ºæˆ‘ä»¬çš„æ–­ç‚¹å†æ·»åŠ å†…å­˜æ–­ç‚¹
![](https://ws4.sinaimg.cn/large/006tKfTcly1fr1untuslrj31kw11ytpm.jpg)

> è¿™æ ·å°±éªŒè¯æˆåŠŸaslr,æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨çš„å¢åŠ aslrçš„åç§»é‡å¹¶æˆåŠŸåˆ©ç”¨å†…å­˜åœ°å€ä¸‹æ–­ç‚¹ğŸ˜†


**æ³¨:**
åœ¨MarchOViewæ‰“å¼€MachOæ–‡ä»¶å¯ä»¥çœ‹åˆ°ä»–çš„ç»“æ„ä¸º:

* header
* load Commands
* Data
	* _text
	* _Data

å…¶å®åœ¨MarchOæ–‡ä»¶ä¸­å¹¶ä¸çœŸå®å­˜åœ¨headerä»¥åŠloadCommands,è¿™ä¸¤é¡¹åªæ˜¯ç»™æˆ‘ä»¬çœ‹çš„,ç¨‹åºçš„èµ·å§‹ä½ç½®å°±æ˜¯_textæ–­çš„ä½ç½®!

## å¯†ç å­¦

### base64
base64åœ¨ç°ä»£çš„åŠ å¯†ä¸­å¾ˆå¸¸è§,å¯ä»¥å¯¹æ‰€æœ‰çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡ŒåŠ å¯†,ä¸€èˆ¬ç”¨äºåŠ å¯†åŠ å¯†åçš„äºŒè¿›åˆ¶,ä¸ä¼šå»åŠ å¯†æ–‡ä»¶

```
base64 123.txt -o 321.txt

```
### åŠ å¯†

* hash(æ•£åˆ—),åŠ å¯†è¿‡ç¨‹ä¸å¯é€†  ç”¨äºæ ¡éªŒ
	* sha1
	* sha256/512

* éå¯¹ç§°åŠ å¯†  RSA
	* å…¬é’¥åŠ å¯†,ç§é’¥è§£å¯†
	* ç§é’¥æ•™ç§˜,å…¬é’¥è§£å¯†  
* å¯¹ç§°åŠ å¯†
	* des
	* 3des
	* aes