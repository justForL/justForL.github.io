---
title: Runtimeåˆé›†

layout: post

tag: iOSåº•å±‚

---
> Runtimeåœ¨OCä¸­å æœ‰ååˆ†é‡è¦çš„åœ°ä½,å°åˆ°å…³è”å±æ€§,å¤§åˆ°å„ç§æ¡†æ¶,æ— ä¸€ä¸èƒ½çœ‹åˆ°å®ƒçš„èº«å½±,ä»Šå¤©ä¸»è¦é’ˆå¯¹å¸¸ç”¨çš„Runtimeæ“ä½œè¿›è¡Œè®°å½•ğŸ˜†

**å‡†å¤‡å·¥ä½œ**

* åˆ›å»ºStudentæ¨¡å‹
* åœ¨æ¨¡å‹é‡Œåªå£°æ˜äº†ä¸¤ä¸ªå±æ€§,å¹¶å£°æ˜äº†æ„é€ æ–¹æ³•,ä»¥åŠeatæ–¹æ³•å’Œrunæ–¹æ³•


## åŠ¨æ€æ”¹å˜å±æ€§å€¼
é¦–å…ˆå¼•ç”¨å¤´æ–‡ä»¶:

```objectivec
#import <objc/runtime.h>
#import <objc/message.h>
```
æ‡’åŠ è½½ä¸€ä¸ªstudentæ¨¡å‹
![](https://ws3.sinaimg.cn/large/006tKfTcly1fq5ah9qj4xj319w088jsw.jpg)
**è¿™é‡Œä½¿ç”¨çš„æ˜¯æ¶ˆæ¯å‘é€å½¢å¼åˆå§‹åŒ–student**

```objectivec

- (Student *)stu {
    if (_stu == nil) {
        
        _stu = ((Student * (*) (id, SEL, NSString *, NSInteger))objc_msgSend)((id) [Student class], @selector(studentWithName:age:),@"å°æ˜",13);
        
    }
    return _stu;
}

```

```objectivec

- (void)changeInstancePropertyValue {
    //ç´¯åŠ è¦è·å–ç±»çš„å±æ€§æ¡æ•°
    unsigned int count = 0;
    //è·å–å±æ€§ä¸ªæ•°çš„é›†åˆ
    Ivar *ivars = class_copyIvarList([self.stu class], &count);
    
    //éå†é›†åˆ
    for (int i = 0; i < count; i++) {
        //è·å¾—å•ä¸ªå±æ€§
        Ivar ivar = ivars[i];
        //è½¬åŒ–æˆcå­—ç¬¦ä¸²
        const char *ivarName = ivar_getName(ivar);
        //å°†cä¸²è½¬åŒ–æˆocå­—ç¬¦ä¸²
        NSString *propertyName = [NSString stringWithUTF8String:ivarName];
        //åˆ¤æ–­ å–å‡ºæƒ³è¦æ”¹å˜å€¼çš„å±æ€§
        if ([propertyName isEqualToString:@"_name"]) {
            object_setIvar(self.stu, ivar, @"å°çº¢");
        }
    }
    NSLog(@"%@---%zd",self.stu.name,self.stu.age);
}

```
## æ–¹æ³•äº¤æ¢
ä¸»è¦ç”¨é€”åœ¨äº,å½“é¡¹ç›®ä¸­éœ€è¦å¤§è§„æ¨¡æ›¿æ¢åŠŸèƒ½æˆ–è€…æ‹“å±•åŠŸèƒ½çš„æ—¶å€™,å½“ç„¶å¯ä»¥ä¸€æ¡ä¸€æ¡å»æ›´æ”¹,ä½†è¿™æ ·æ•ˆç‡æ˜¯æœ€ä½çš„,è¿™æ—¶å€™runtimeçš„äº¤æ¢æ–¹æ³•å°±å¯ä»¥å¾ˆè½»æ¾çš„è§£å†³è¿™ä¸ªé—®é¢˜,ä»¥æœ¬demoä¸­çš„studentæ¨¡å‹ä¸ºä¾‹,è¦æ›¿æ¢eatæ–¹æ³•å’Œrunæ–¹æ³•

`é¦–å…ˆ`,è·å–eatæ–¹æ³•çš„Method:

```objectivec
Method eatMethod = class_getInstanceMethod([self.stu class], @selector(eat));

```
`å…¶æ¬¡`,è·å–runæ–¹æ³•:
```objectivec
Method runMethod = class_getInstanceMethod([self.stu class], @selector(run));
```

`æœ€å`,äº¤æ¢æ–¹æ³•å³å¯:
```objectivec
method_exchangeImplementations(runMethod, eatMethod);
```

å½“å†æ¬¡è°ƒç”¨eatæ–¹æ³•æ—¶å€™,å°±å·²ç»è¢«è°ƒæ¢æˆrunæ–¹æ³•äº†
## åŠ¨æ€å…³è”
æˆ‘ä»¬ä¸ºstudentæ¨¡å‹æ·»åŠ ä¸€ä¸ªcotegory(Student+New),ä¸»è¦ä¸ºäº†æ ‡è¯†æ˜¯ä¸æ˜¯æ–°å…¥å­¦çš„å­¦ç”Ÿ,

![](https://ws4.sinaimg.cn/large/006tKfTcly1fq5az02jjmj30mw04ajrx.jpg)
**æ³¨æ„:**

è¿™æ˜¯å£°æ˜äº†isNewçš„setterå’Œgetteræ–¹æ³•,å¹¶ä¸æ˜¯å®šä¹‰äº†ä¸€ä¸ªå±æ€§.

ç”±runtimeæä¾›çš„æ¥å£å¯ä»¥çœ‹åˆ°

```objectivec
 objc_setAssociatedObject(id  _Nonnull object, const void * _Nonnull key, id  _Nullable value, objc_AssociationPolicy policy)
```

* object: å½“å‰ç±»çš„å®ä¾‹  å†™self
* key: ç”¨äºè®°å½•å½“å‰å€¼å¾—æ ‡è¯†ç¬¦
* value: æƒ³è¦å­˜å‚¨çš„å€¼
* policy: ç­–ç•¥,å£°æ˜å±æ€§æ—¶çš„ä¿®é¥°ç¬¦

`é¦–å…ˆ`å†™å‡ºå£°æ˜çš„setterå’Œgetteræ–¹æ³•:

```objectivec
- (void)setIsNew:(BOOL)isNew {
}


- (BOOL)isNew {
}

```
`å…¶æ¬¡`å®šä¹‰ä¸€ä¸ªé™æ€å˜é‡

```objectivec
static const char _isNew;
```
`æœ€å`åœ¨setterå’Œgetteræ–¹æ³•ä¸­å¡«å†™runtimeæ–¹æ³•:

```objectivec
- (void)setIsNew:(BOOL)isNew {
    objc_setAssociatedObject(self, &_isNew, @(isNew), OBJC_ASSOCIATION_ASSIGN);
}


- (BOOL)isNew {
    return [objc_getAssociatedObject(self, &_isNew) boolValue];
}

```
> è¿™é‡Œå‚è€ƒ`FDTemplateLayoutCell`çš„å®ç°ä¸­,è¿˜å¯ä»¥æœ‰å¦å¤–ä¸€ç§å†™æ³•

```objectivec
- (void)setIsNew:(BOOL)isNew {
    objc_setAssociatedObject(self, @selector(isNew), @(isNew), OBJC_ASSOCIATION_ASSIGN);
}


- (BOOL)isNew {
    return [objc_getAssociatedObject(self, _cmd) boolValue];
}
```

![](https://ws4.sinaimg.cn/large/006tKfTcly1fq5bob165kj313c0va43j.jpg)

**æ³¨æ„:**åœ¨æ­¤setteræ–¹æ³•ä¸­å¿…é¡»è¦ä½¿ç”¨@selector(isNew)æ¥æ›¿ä»£è‡ªå®šä¹‰çš„key,getteræ–¹æ³•ä¸­å¯ä»¥çœç•¥ä½¿ç”¨_cmd.