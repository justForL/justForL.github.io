---
title: 汇编(二)

layout: post

tags: 汇编

---

## 关于CPU

### 寄存器
CPU除了控制器,运算器,还有寄存器,其中寄存器的作用就是进行数据的临时存储
> CPU的运算速度是非常快的,为了性能CPU在内部开辟了一小块临时存储区域,并在进行运算时先将数据从内存赋值到这一小块临时存储区域中,运算时就在这一小块临时存储区域内进行.我们称这一小块临时存储区域为寄存器

对于ARM64系的CPU来说,如果寄存器以X开头则表明的是一个64位的寄存器,以W开头就表明是一个32位存储器,在系统中并没有提供16和8位的次存器供访问和使用.其中32的寄存器就是64位寄存器的低32位部分,并不是独立存在的

### 高速缓存

iPhoneX上搭载的是ARM处理器A11它的1级缓存的容量是64KB,2级缓存的容量为8M,**iPhoneX只有两级缓存**
> CPU每执行一条指令前都需要从内存中将指令读取到CPU内并执行,而寄存器的运行速度相比内存读写速度要快很多,为了性能,CPU还集成了一个高速缓冲区域,当程序在运行时,先将要执行的指令代码以及数据复制到高速缓存中去(由操作系统完成).CPU直接从高速缓存依次读取去指令来执行.


## 寄存器的补充

### 数据地址寄存器

数据地址寄存器通常用来做数据计算的临时存储,做累加计数地址保存等功能.定义这些寄存器的作用主要是用于在CPU指令中保存操作数,在CPU中当做一些常规变量来使用

**ARM64中**
* 64位:X0-X30,XZR(零寄存器)
* 32位:W0-W30,WZR(灵寄存器)
> 与8086不同的是,CS,DS,SS,ES这四个寄存器在ARM架构中并不存在,这个属于intel架构


### 浮点和向量寄存器

因为浮点数的存储以及其运算的特殊性,CPU中专门提供了浮点数寄存器来处理浮点数

* 浮点寄存器64位:D0-D31
* 浮点寄存器32位:S0-S31

现在的CPU支持向量运算(向量运算在图形处理领域用的非常的多),为了支持向量计算,系统提供了众多的向量寄存器

* 向量寄存器(128位): V0-V31

## 栈

栈是一种具有特殊的访问方式的存储空间(FILO)

### SP和FP寄存器
* sp寄存器在任意时刻会保存我们的栈底地址
* fp寄存器也就是arm64中的x29寄存器,我们利用它保存栈顶地址

> 注意:
>
 * 在ARM64开始,取消32位的LDM,STM,PUSH,POP指令!取而代之的是ldr/ldp,str/stp 
 * ARM64中,对栈的操作是16字节对齐的


### 栈空间拉伸
栈的空间申请是由高地址向底地址申请的

### 内存读写指令
与栈的空间申请方式相反,是由高地址向底地址读写的

* **str(store register)指令**

	将数据从寄存器中读出来,存到内存中

* **ldr(load register)指令**

	将数据从内存中读出来,存到存储器中

> ldp,stp是ldr,str的变种,可以同时操作两个寄存器

### 堆栈练习 (Demo->test1())
使用32个字节空间作为这段程序的栈空间,然后利用栈将x0和x1的值进行交换.

```assembly
sub    sp, sp, #0x20	;拉伸栈空间32个字节
stp    x0, x1, [sp, #0x10] ;sp往上加16个字节,存放x0 和 x1
ldp    x1, x0, [sp, #0x10] ;将sp偏移16个字节的值取出来,放入x1 和 x0
```

## bl和ret指令
### bl标号

* 将下一条指令的地址放入lr(x30)寄存器
* 转到标号处执行指令

### ret

* 默认使用lr(x30)寄存器的值,通过底层指令提示CPU此处作为下条指令地址!

> ARM64平台的特色指令,它面向硬件做了优化处理的

### x30寄存器
x30寄存器存放的是函数的返回地址.当ret指令执行时刻,会寻找x30寄存器保存的地址值!

> 注意:在函数嵌套调用的时候.需要将x30入栈!

#### 练习:
* 编写两个数求和(**Demo->test2()**)

```assembly
_Sum:
    sub sp, sp, #0x20
    stp x29, x30, [sp]
    add x0, x0, x1
    ldp x29, x30, [sp]
    add sp, sp, #0x20
    ret
```


## 函数的参数和返回值
ARM64下,**函数的参数**是存放在X0到X7(W0到W7)这8个寄存器里面的.如果超过8个参数,就会入栈.
**函数的返回值**是放在X0 寄存器里面的.


## 函数的局部变量
函数的局部变量放在栈里面!

## Demo

[Demo](https://github.com/justForL/assmeblyDemo)
